<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tank VN - Trò Chơi Đố Vui (Táo Bắc Việt Team)</title>
<link rel="icon" href="favicon.png" type="image/png" />
<style>
  :root{
    --glass-bg: rgba(0,0,0,0.65);
    --accent: #ffcc00;
    --correct: #1db954;
    --wrong: #e53e3e;
    --white: #ffffff;
  }
  html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;color:var(--white);}
  body{
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    background:#222;
    transition: background 0.5s ease;
  }

  /* Slideshow background container (full-screen) */
  .bg-slideshow{
    position:fixed;
    inset:0;
    z-index:0;
    background:linear-gradient(135deg,#283048,#859398);
    background-size:cover;
    background-position:center;
  }

  /* overlay to dim slideshow */
  .bg-overlay{
    position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:1;
  }

  /* Main card */
  .card{
    position:relative;
    z-index:2;
    width:min(920px,94%);
    max-width:920px;
    background: linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.55));
    border-radius:14px;
    padding:22px;
    box-shadow:0 10px 40px rgba(0,0,0,0.6);
    display:grid;
    grid-template-columns: 1fr 360px;
    gap:18px;
    align-items:start;
    color:var(--white);
    border:1px solid rgba(255,255,255,0.06);
  }

  /* Left: question area */
  .left {
    padding:12px;
  }
  .logo {
    width:86px; height:86px; object-fit:contain; border-radius:8px; background:rgba(255,255,255,0.06); padding:8px;
  }
  .title { font-size:22px; margin:8px 0 4px 0; color:var(--accent); font-weight:700; }
  .subtitle { font-size:13px; color:rgba(255,255,255,0.85); margin-bottom:12px; }

  /* Question box: black glass */
  .question-box{
    background: var(--glass-bg);
    border-radius:10px;
    padding:18px;
    min-height:160px;
    display:flex;
    flex-direction:column;
    justify-content:center;
    gap:12px;
    border:1px solid rgba(255,255,255,0.05);
  }
  .question-text{
    color:var(--white);
    font-size:20px;
    line-height:1.25;
    font-weight:600;
  }

  .answer-row{
    display:flex;
    gap:10px;
    align-items:center;
    margin-top:6px;
  }

  input[type="text"]{
    flex:1;
    padding:10px 12px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.12);
    background:rgba(255,255,255,0.04);
    color:var(--white);
    outline:none;
    font-size:15px;
  }
  button.btn{
    padding:10px 14px;
    border-radius:8px;
    border:none;
    background:var(--accent);
    color:#111;
    font-weight:700;
    cursor:pointer;
  }
  button.btn:disabled{opacity:0.6; cursor:not-allowed;}

  .meta {
    display:flex;
    gap:12px;
    margin-top:8px;
    color:rgba(255,255,255,0.85);
    font-size:13px;
    align-items:center;
  }

  /* timer style */
  .timer {
    background: rgba(255,255,255,0.04);
    padding:6px 10px;
    border-radius:8px;
    font-weight:700;
  }

  /* Right: leaderboard & controls */
  .right {
    padding:12px;
  }
  .card-panel{
    background: rgba(255,255,255,0.04);
    padding:12px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.03);
  }
  h3{margin:6px 0 8px 0;}
  ul.leaderboard-list{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px; }
  ul.leaderboard-list li{
    background: rgba(0,0,0,0.25);
    padding:8px 10px;
    border-radius:8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-weight:600;
    color:var(--white);
  }

  .small { font-size:13px; color:rgba(255,255,255,0.8); }

  /* Toast (center big) */
  .center-toast{
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    z-index:999;
    min-width:320px;
    max-width:90%;
    background:rgba(0,0,0,0.8);
    color:var(--white);
    border-radius:12px;
    padding:18px 20px;
    text-align:center;
    box-shadow:0 12px 40px rgba(0,0,0,0.6);
    border:3px solid rgba(255,255,255,0.06);
    display:none;
  }
  .center-toast.correct{ background: linear-gradient(90deg, rgba(27, 189, 120,0.95), rgba(29,185,144,0.95)); color:#fff;}
  .center-toast.wrong{ background: linear-gradient(90deg, rgba(224,78,78,0.95), rgba(229,62,62,0.95)); color:#fff;}
  .center-toast h2{ margin:0 0 6px 0; font-size:20px; }
  .center-toast p{ margin:0; opacity:0.95; font-weight:600;}
  .center-toast .next-note{ margin-top:10px; font-size:13px; opacity:0.95;}

  /* responsive */
  @media (max-width:860px){
    .card{ grid-template-columns:1fr; max-width:94%; }
    .right{ order:2; }
  }
</style>
</head>
<body>
  <!-- background slideshow -->
  <div id="bg" class="bg-slideshow"></div>
  <div class="bg-overlay"></div>

  <main class="card" role="main">
    <section class="left">
      <img src="logo.png" alt="logo" class="logo" />
      <div class="title">Tank VN — Trò Chơi Đố Vui</div>
      <div class="subtitle">© Táo Bắc Việt Team — Code by Táo Đỏ · Ý tưởng: Táo Xanh Lá · Ảnh: NVT Studio</div>

      <div id="questionArea" class="question-box">
        <div id="questionText" class="question-text">Vui lòng đăng nhập để bắt đầu.</div>

        <div class="answer-row">
          <input id="answerInput" type="text" placeholder="Nhập đáp án..." autocomplete="off" />
          <button id="answerBtn" class="btn">Trả lời</button>
        </div>

        <div class="meta">
          <div id="scoreDisplay" class="small">Điểm: 0 / 100</div>
          <div id="qIndexDisplay" class="small">Câu: 0 / 100</div>
          <div id="timerDisplay" class="timer">⏳ 15s</div>
        </div>
      </div>

    </section>

    <aside class="right">
      <div class="card-panel">
        <h3>Người chơi</h3>
        <div id="loginPanel">
          <input id="playerName" type="text" placeholder="Tên của bạn" />
          <button id="startBtn" class="btn" style="margin-top:8px;">Bắt đầu</button>
        </div>
        <div id="inGameInfo" style="display:none;">
          <div class="small">Người chơi: <strong id="playerNameShow"></strong></div>
          <div style="height:10px"></div>
          <div style="display:flex;gap:8px;">
            <button id="restartBtn" class="btn" style="background:#ff6b6b;">Chơi lại</button>
            <button id="toggleBgmBtn" class="btn" style="background:#6bffb0;">Tắt nhạc</button>
          </div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card-panel">
        <h3>Bảng xếp hạng (Top)</h3>
        <ul id="leaderboard" class="leaderboard-list"></ul>
      </div>
    </aside>
  </main>

  <!-- center toast -->
  <div id="centerToast" class="center-toast" role="status" aria-live="polite">
    <h2 id="toastTitle">Đáp án chính xác!</h2>
    <p id="toastMsg">Bạn giành 1 điểm</p>
    <div class="next-note">Chuyển câu tiếp sau <span id="countdown">5</span>s...</div>
  </div>

<script>
/* ===========================
   CONFIG & DATA
   =========================== */
const TOTAL_QUESTIONS = 100;
const SLIDESHOW_INTERVAL_MS = 5000; // change background every 5s
const TOAST_SHOW_SECONDS = 5;       // show toast for 5s before next question
const BG_COUNT = 34;                // number of background images (bg1.jpg ... bg34.jpg)
const BG_PREFIX = 'bg';             // bg1.jpg...
const BG_EXT = '.jpg';              // extension for background images
const TIME_PER_QUESTION = 15;       // seconds per question

const questions = [
  { question: "(1) Ai là người sáng lập nước Văn Lang?", answer: "Hùng Vương" },
  { question: "(2) Ai là người lãnh đạo khởi nghĩa Lam Sơn?", answer: "Lê Lợi" },
  { question: "(3) Ai viết Bình Ngô đại cáo?", answer: "Nguyễn Trãi" },
  { question: "(4) Ai là danh tướng dẹp Tống và Bình Chiêm?", answer: "Lý Thường Kiệt" },
  { question: "(5) Ai là người thắng trận Bạch Đằng năm 938?", answer: "Ngô Quyền" },
  { question: "(6) Ai xây dựng kinh thành Thăng Long?", answer: "Lý Công Uẩn" },
  { question: "(7) Ai là vị vua có niên hiệu Thánh Tông nhà Lý?", answer: "Lý Thánh Tông" },
  { question: "(8) Ai là danh y nổi tiếng với tên Hải Thượng Lãn Ông?", answer: "Lê Hữu Trác" },
  { question: "(9) Ai là tác giả Truyện Kiều?", answer: "Nguyễn Du" },
  { question: "(10) Ai là người sáng lập triều Nguyễn?", answer: "Gia Long" },
  /* ... (giữ nguyên danh sách 100 câu như trước) ... */
  { question: "(11) Ai được gọi là Anh hùng áo vải?", answer: "Quang Trung" },
  { question: "(12) Ai là nữ tướng nổi tiếng thời Hai Bà Trưng?", answer: "Bùi Thị Xuân" },
  { question: "(13) Ai là tổng đốc tử thủ thành Hà Nội năm 1882?", answer: "Hoàng Diệu" },
  { question: "(14) Ai là người có công cải cách ruộng đất ở Bắc Bộ?", answer: "Nguyễn Công Trứ" },
  { question: "(15) Ai là người “thay áo hoàng bào cứu vua”?", answer: "Lê Lai" },
  { question: "(16) Ai là danh tướng thủy quân triều Trần?", answer: "Trần Hưng Đạo" },
  { question: "(17) Ai là nữ anh hùng dân tộc, người Tày?", answer: "Nùng Trí Cao" },
  { question: "(18) Ai là người sáng lập đạo Cao Đài?", answer: "Ngô Văn Chiêu" },
  { question: "(19) Ai là vua nổi tiếng với chính sách “Ngụ binh ư nông”?", answer: "Trần Hưng Đạo" },
  { question: "(20) Ai là nhà toán học nổi tiếng thời Lê?", answer: "Lương Thế Vinh" },
  { question: "(21) Hồ Hoàn Kiếm gắn với truyền thuyết vua nào?", answer: "Lê Lợi" },
  { question: "(22) Văn Miếu – Quốc Tử Giám được lập dưới triều nào?", answer: "Lý Thánh Tông" },
  { question: "(23) Ai là vua đầu tiên đặt niên hiệu ở Việt Nam?", answer: "Lý Nam Đế" },
  { question: "(24) Ai là tác giả Hịch tướng sĩ?", answer: "Trần Hưng Đạo" },
  { question: "(25) Ai là người chế tạo súng thần công?", answer: "Trần Đại Nghĩa" },
  { question: "(26) Ai là người đánh đuổi quân Nguyên Mông lần 3?", answer: "Trần Nhân Tông" },
  { question: "(27) Ai là nữ anh hùng mở đầu khởi nghĩa chống Bắc thuộc?", answer: "Hai Bà Trưng" },
  { question: "(28) Ai là người chỉ huy khởi nghĩa Bãi Sậy?", answer: "Nguyễn Thiện Thuật" },
  { question: "(29) Ai là vua cuối cùng của triều Lê?", answer: "Lê Chiêu Thống" },
  { question: "(30) Ai là vua cuối cùng của triều Nguyễn?", answer: "Bảo Đại" },
  { question: "(31) Quốc hiệu đầu tiên của nước ta là gì?", answer: "Văn Lang" },
  { question: "(32) Quốc hiệu Đại Việt được đặt dưới triều nào?", answer: "Lý" },
  { question: "(33) Quốc hiệu Đại Ngu thuộc triều nào?", answer: "Hồ" },
  { question: "(34) Ai là thủ lĩnh nghĩa quân Tây Sơn?", answer: "Nguyễn Huệ" },
  { question: "(35) Ai là vua có công khai hoang vùng Đồng Tháp Mười?", answer: "Nguyễn Ánh" },
  { question: "(36) Ai là người chế ra chữ quốc ngữ?", answer: "Alexandre de Rhodes" },
  { question: "(37) Ai là người khởi xướng phong trào Đông Du?", answer: "Phan Bội Châu" },
  { question: "(38) Ai là nhà yêu nước chủ trương Duy Tân?", answer: "Phan Chu Trinh" },
  { question: "(39) Ai là người sáng tác Quốc ca Việt Nam?", answer: "Văn Cao" },
  { question: "(40) Ai là Chủ tịch nước Việt Nam Dân chủ Cộng hòa đầu tiên?", answer: "Hồ Chí Minh" },
  { question: "(41) Ai là tổng tư lệnh Quân đội Nhân dân Việt Nam?", answer: "Võ Nguyên Giáp" },
  { question: "(42) Trận Điện Biên Phủ diễn ra năm nào?", answer: "1954" },
  { question: "(43) Hiệp định Paris được ký kết năm nào?", answer: "1973" },
  { question: "(44) Ai là phi công bắn rơi nhiều máy bay Mỹ nhất?", answer: "Nguyễn Văn Cốc" },
  { question: "(45) Ai là anh hùng liệt sĩ Lái Thiêu?", answer: "Nguyễn Văn Trỗi" },
  { question: "(46) Ai là thiếu nhi anh hùng ở Nghệ An?", answer: "Kim Đồng" },
  { question: "(47) Ai là Tổng Bí thư đầu tiên của Đảng?", answer: "Trần Phú" },
  { question: "(48) Ai là Tổng Bí thư trong Cách mạng tháng Tám?", answer: "Trường Chinh" },
  { question: "(49) Quốc khánh Việt Nam là ngày nào?", answer: "2/9/1945" },
  { question: "(50) Ngày Giải phóng miền Nam là ngày nào?", answer: "30/4/1975" },
  { question: "(51) Ai là người khởi nghĩa Yên Thế?", answer: "Hoàng Hoa Thám" },
  { question: "(52) Ai là vua lập ra triều Tiền Lê?", answer: "Lê Đại Hành" },
  { question: "(53) Ai là người đánh tan quân Nam Hán trên sông Bạch Đằng?", answer: "Ngô Quyền" },
  { question: "(54) Ai là vị vua có công dời đô ra Thăng Long?", answer: "Lý Công Uẩn" },
  { question: "(55) Ai là vị vua đặt quốc hiệu Đại Cồ Việt?", answer: "Đinh Tiên Hoàng" },
  { question: "(56) Ai là người khai sáng triều Trần?", answer: "Trần Thái Tông" },
  { question: "(57) Ai là nữ chính cung của vua Quang Trung?", answer: "Ngọc Hân công chúa" },
  { question: "(58) Ai là vua đầu tiên của triều Lý?", answer: "Lý Công Uẩn" },
  { question: "(59) Ai là nhà sử học viết Đại Việt sử ký toàn thư?", answer: "Ngô Sĩ Liên" },
  { question: "(60) Ai là thi sĩ tác giả Chinh phụ ngâm?", answer: "Đặng Trần Côn" },
  { question: "(61) Ai là nhà thơ làm quan triều Mạc, nổi tiếng với Truyền kỳ mạn lục?", answer: "Nguyễn Dữ" },
  { question: "(62) Ai là người đặt nền móng văn học chữ Nôm?", answer: "Nguyễn Trãi" },
  { question: "(63) Ai là tác giả thơ “Nam quốc sơn hà”?", answer: "Lý Thường Kiệt" },
  { question: "(64) Ai là nhà thơ trào phúng nổi tiếng?", answer: "Hồ Xuân Hương" },
  { question: "(65) Ai là tác giả thơ “Hịch tướng sĩ”?", answer: "Trần Hưng Đạo" },
  { question: "(66) Ai là tác giả “Bình Ngô đại cáo”?", answer: "Nguyễn Trãi" },
  { question: "(67) Ai là người giữ thành Cửa Nam kiên cường?", answer: "Nguyễn Tri Phương" },
  { question: "(68) Ai là vua có công mở mang bờ cõi phương Nam?", answer: "Nguyễn Hoàng" },
  { question: "(69) Ai là nhà văn hóa nổi tiếng thời Nguyễn?", answer: "Nguyễn Đình Chiểu" },
  { question: "(70) Ai là nhà yêu nước với tác phẩm Hịch khởi nghĩa?", answer: "Phan Bội Châu" },
  { question: "(71) Ai là người khai phá vùng đất Nam Bộ?", answer: "Nguyễn Hữu Cảnh" },
  { question: "(72) Ai là nhà thơ nổi tiếng với tác phẩm Lục Vân Tiên?", answer: "Nguyễn Đình Chiểu" },
  { question: "(73) Ai là vua có công thống nhất đất nước sau loạn 12 sứ quân?", answer: "Đinh Bộ Lĩnh" },
  { question: "(74) Ai là người sáng lập triều Tây Sơn?", answer: "Nguyễn Nhạc" },
  { question: "(75) Ai là người đánh tan quân Xiêm ở Rạch Gầm – Xoài Mút?", answer: "Nguyễn Huệ" },
  { question: "(76) Ai là người khai sáng đạo Phật Việt Nam?", answer: "Khương Tăng Hội" },
  { question: "(77) Ai là người lập ra hệ thống Văn Miếu?", answer: "Lý Thánh Tông" },
  { question: "(78) Ai là danh tướng nổi tiếng triều Trần, em Trần Hưng Đạo?", answer: "Trần Quang Khải" },
  { question: "(79) Ai là danh tướng nhà Lý, từng đánh Tống?", answer: "Tôn Đản" },
  { question: "(80) Ai là anh hùng nông dân thế kỷ XVIII?", answer: "Nguyễn Tuyển" },
  { question: "(81) Ai là vua khởi xướng cải cách Minh Trị ở Việt Nam?", answer: "Không có, ở Nhật Bản" },
  { question: "(82) Ai là thủ lĩnh khởi nghĩa Hương Khê?", answer: "Phan Đình Phùng" },
  { question: "(83) Ai là thủ lĩnh khởi nghĩa Ba Đình?", answer: "Đinh Công Tráng" },
  { question: "(84) Ai là người thành lập Hội Việt Nam Cách mạng Thanh niên?", answer: "Nguyễn Ái Quốc" },
  { question: "(85) Ai là người sáng lập báo Thanh Niên?", answer: "Nguyễn Ái Quốc" },
  { question: "(86) Ai là người đọc Tuyên ngôn độc lập 2/9/1945?", answer: "Hồ Chí Minh" },
  { question: "(87) Ai là người khởi nghĩa Nam Kỳ 1940?", answer: "Nguyễn Văn Cừ" },
  { question: "(88) Ai là người chỉ huy quân Giải phóng tiến vào Dinh Độc Lập 1975?", answer: "Bùi Quang Thận" },
  { question: "(89) Ai là nhạc sĩ sáng tác “Tiến quân ca”?", answer: "Văn Cao" },
  { question: "(90) Ai là nhà thơ được mệnh danh là “ông hoàng thơ tình”?", answer: "Xuân Diệu" },
  { question: "(91) Ai là nhà thơ với tập Nhật ký trong tù?", answer: "Hồ Chí Minh" },
  { question: "(92) Ai là người thành lập Nhà máy in tiền đầu tiên?", answer: "Trần Đại Nghĩa" },
  { question: "(93) Ai là người mở chiến dịch Hồ Chí Minh 1975?", answer: "Văn Tiến Dũng" },
  { question: "(94) Ai là nhà thơ nổi tiếng với bài Tây Tiến?", answer: "Quang Dũng" },
  { question: "(95) Ai là nhà văn với tác phẩm Vợ nhặt?", answer: "Kim Lân" },
  { question: "(96) Ai là nhà văn với tác phẩm Chí Phèo?", answer: "Nam Cao" },
  { question: "(97) Ai là nhà văn với tác phẩm Tắt đèn?", answer: "Ngô Tất Tố" },
  { question: "(98) Ai là nhà văn với tác phẩm Số đỏ?", answer: "Vũ Trọng Phụng" },
  { question: "(99) Ai là nhà thơ với tập Bên kia sông Đuống?", answer: "Hoàng Cầm" },
  { question: "(100) Ai là nhà thơ nổi tiếng với tập Trường ca Mặt đường khát vọng?", answer: "Nguyễn Khoa Điềm" }
];

/* ===========================
   STATE
   =========================== */
let currentIndex = 0;
let score = 0;
let playerName = '';
let answeringLocked = false;
let toastTimer = null;
let toastCountdownTimer = null;

/* timer */
let questionTimer = null;
let timeLeft = TIME_PER_QUESTION;

/* bg slideshow */
let bgIndex = 1;

/* audio */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = AudioCtx ? new AudioCtx() : null;
let bgm = null;
let bgmPlaying = false;

/* ===========================
   DOM refs
   =========================== */
const bgEl = document.getElementById('bg');
const qText = document.getElementById('questionText');
const answerInput = document.getElementById('answerInput');
const answerBtn = document.getElementById('answerBtn');
const scoreDisplay = document.getElementById('scoreDisplay');
const qIndexDisplay = document.getElementById('qIndexDisplay');
const timerDisplay = document.getElementById('timerDisplay');

const startBtn = document.getElementById('startBtn');
const playerNameInput = document.getElementById('playerName');
const playerNameShow = document.getElementById('playerNameShow');
const restartBtn = document.getElementById('restartBtn');
const loginPanel = document.getElementById('loginPanel');
const inGameInfo = document.getElementById('inGameInfo');
const toggleBgmBtn = document.getElementById('toggleBgmBtn');

const centerToast = document.getElementById('centerToast');
const toastTitle = document.getElementById('toastTitle');
const toastMsg = document.getElementById('toastMsg');
const countdownEl = document.getElementById('countdown');

const leaderboardEl = document.getElementById('leaderboard');

/* ===========================
   AUDIO: Web Audio simple beeps
   =========================== */
function beep(frequency=440, duration=150, type='sine', ramp=0.02){
  if(!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.value = frequency;
  g.gain.setValueAtTime(0, audioCtx.currentTime);
  g.gain.linearRampToValueAtTime(0.12, audioCtx.currentTime + ramp);
  g.gain.linearRampToValueAtTime(0.0, audioCtx.currentTime + duration/1000);
  o.connect(g);
  g.connect(audioCtx.destination);
  o.start();
  setTimeout(()=>{ try{o.stop()}catch(e){} }, duration+20);
}

function playCorrect(){
  if(audioCtx && audioCtx.state === 'suspended'){ try{ audioCtx.resume(); }catch(e){} }
  beep(880,90); setTimeout(()=>beep(1100,70),90);
}
function playWrong(){
  if(audioCtx && audioCtx.state === 'suspended'){ try{ audioCtx.resume(); }catch(e){} }
  beep(240,300,'square');
}

/* ===========================
   BACKGROUND SLIDESHOW
   =========================== */
function setBgImage(i){
  const url = `${BG_PREFIX}${i}${BG_EXT}`;
  bgEl.style.background = `url("${url}") center/cover no-repeat`;
}
function startSlideshow(){
  setBgImage(bgIndex);
  setInterval(()=>{
    bgIndex++;
    if(bgIndex>BG_COUNT) bgIndex = 1;
    setBgImage(bgIndex);
  }, SLIDESHOW_INTERVAL_MS);
}

/* ===========================
   BGM control
   =========================== */
function initBgm(){
  if(!bgm){
    bgm = new Audio("task.mp3");
    bgm.loop = true;
    bgm.volume = 0.33;
    bgm.preload = 'auto';
  }
}
function playBgm(){
  if(!bgm) initBgm();
  // resume audio context if present (for beep sounds)
  if(audioCtx && audioCtx.state === 'suspended'){
    audioCtx.resume().catch(()=>{});
  }
  bgm.play().then(()=>{ bgmPlaying = true; toggleBgmBtn.textContent = 'Tắt nhạc'; })
  .catch(()=>{ /* autoplay blocked, will resume on user gesture */ });
}
function pauseBgm(){
  if(bgm){ bgm.pause(); bgmPlaying = false; toggleBgmBtn.textContent = 'Mở nhạc'; }
}

/* ===========================
   UI helpers
   =========================== */
function updateUI(){
  scoreDisplay.textContent = `Điểm: ${score} / ${TOTAL_QUESTIONS}`;
  qIndexDisplay.textContent = `Câu: ${Math.min(currentIndex+1,TOTAL_QUESTIONS)} / ${TOTAL_QUESTIONS}`;
}

function showQuestion(idx){
  const q = questions[idx];
  qText.textContent = q.question;
  answerInput.value = '';
  answerInput.focus();
  updateUI();
  answeringLocked = false;
  answerBtn.disabled = false;
  answerInput.disabled = false;
  startQuestionTimer();
}

/* ===========================
   TIMER: per-question countdown
   =========================== */
function startQuestionTimer(){
  clearInterval(questionTimer);
  timeLeft = TIME_PER_QUESTION;
  timerDisplay.textContent = `⏳ ${timeLeft}s`;
  questionTimer = setInterval(()=>{
    timeLeft--;
    if(timeLeft < 0) timeLeft = 0;
    timerDisplay.textContent = `⏳ ${timeLeft}s`;
    if(timeLeft <= 0){
      clearInterval(questionTimer);
      handleTimeUp();
    }
  },1000);
}
function stopQuestionTimer(){
  clearInterval(questionTimer);
}

/* ===========================
   ANSWER FLOW
   =========================== */
function onAnswerSubmit(){
  if(answeringLocked) return;
  answeringLocked = true;
  stopQuestionTimer();
  const user = (answerInput.value || '').trim();
  const correct = (questions[currentIndex].answer || '').trim();

  const normalize = s => s.replace(/\s+/g,' ').trim().toLowerCase();
  const isCorrect = normalize(user) === normalize(correct);

  // clear any existing toast timers
  clearToastTimers();

  if(isCorrect){
    score += 1;            // each question 1 điểm
    playCorrect();
    showCenterToast("Đáp án chính xác", `+1 điểm`, true, TOAST_SHOW_SECONDS);
  } else {
    playWrong();
    showCenterToast("Sai rồi", `Đáp án đúng: ${correct}`, false, TOAST_SHOW_SECONDS);
  }

  updateUI();
  answerBtn.disabled = true;
  answerInput.disabled = true;

  // countdown inside toast
  let remaining = TOAST_SHOW_SECONDS;
  countdownEl.textContent = remaining;
  toastCountdownTimer = setInterval(()=>{
    remaining--;
    if(remaining>=0) countdownEl.textContent = remaining;
  },1000);

  toastTimer = setTimeout(()=>{ proceedToNextAfterToast(); }, TOAST_SHOW_SECONDS*1000);
}

/* called when time runs out */
function handleTimeUp(){
  if(answeringLocked) return;
  answeringLocked = true;
  const correct = (questions[currentIndex].answer || '').trim();
  playWrong();
  showCenterToast("Hết giờ!", `Đáp án đúng: ${correct}`, false, TOAST_SHOW_SECONDS);

  // disable input
  answerBtn.disabled = true;
  answerInput.disabled = true;

  // countdown inside toast
  clearToastTimers();
  let remaining = TOAST_SHOW_SECONDS;
  countdownEl.textContent = remaining;
  toastCountdownTimer = setInterval(()=>{
    remaining--;
    if(remaining>=0) countdownEl.textContent = remaining;
  },1000);

  toastTimer = setTimeout(()=>{ proceedToNextAfterToast(); }, TOAST_SHOW_SECONDS*1000);
}

/* proceed to next question (used by both onAnswerSubmit and time up) */
function proceedToNextAfterToast(){
  clearToastTimers();
  hideCenterToast();
  currentIndex++;
  answeringLocked = false;
  answerInput.disabled = false;
  if(currentIndex < TOTAL_QUESTIONS && currentIndex < questions.length){
    showQuestion(currentIndex);
  } else {
    endGame();
  }
}

/* clear existing toast timers */
function clearToastTimers(){
  if(toastTimer){ clearTimeout(toastTimer); toastTimer = null; }
  if(toastCountdownTimer){ clearInterval(toastCountdownTimer); toastCountdownTimer = null; }
}

/* ===========================
   Center toast controls
   =========================== */
function showCenterToast(title, msg, correct, seconds){
  centerToast.style.display = 'block';
  centerToast.classList.remove('correct','wrong');
  centerToast.classList.add(correct ? 'correct' : 'wrong');
  toastTitle.textContent = title;
  toastMsg.textContent = msg;
  countdownEl.textContent = seconds;
}
function hideCenterToast(){
  centerToast.style.display = 'none';
}

/* ===========================
   Leaderboard (localStorage)
   =========================== */
const LB_KEY = 'tankvn_leaderboard';
function saveScore(name, sc){
  if(!name) name = 'Người chơi';
  const list = JSON.parse(localStorage.getItem(LB_KEY) || '[]');
  list.push({ name, score: sc, date: (new Date()).toISOString() });
  list.sort((a,b)=> b.score - a.score);
  localStorage.setItem(LB_KEY, JSON.stringify(list.slice(0,20)));
}
function updateLeaderboard(){
  const list = JSON.parse(localStorage.getItem(LB_KEY) || '[]');
  leaderboardEl.innerHTML = '';
  if(list.length===0){
    const li = document.createElement('li');
    li.textContent = 'Chưa có ai ghi điểm';
    leaderboardEl.appendChild(li);
    return;
  }
  list.slice(0,10).forEach((entry, idx)=>{
    const li = document.createElement('li');
    li.innerHTML = `<span>${idx+1}. ${entry.name}</span><strong>${entry.score} điểm</strong>`;
    leaderboardEl.appendChild(li);
  });
}

/* ===========================
   START / RESTART handlers
   =========================== */
startBtn.addEventListener('click', ()=>{
  const val = (playerNameInput.value || '').trim();
  if(!val) { alert('Vui lòng nhập tên của bạn'); playerNameInput.focus(); return; }
  playerName = val;
  playerNameShow.textContent = playerName;
  loginPanel.style.display = 'none';
  inGameInfo.style.display = 'block';
  currentIndex = 0;
  score = 0;
  updateLeaderboard();
  updateUI();
  showQuestion(currentIndex);

  // enable inputs now, ensure audio context resume and start bgm
  if(audioCtx && audioCtx.state === 'suspended'){
    audioCtx.resume().catch(()=>{});
  }
  playBgm();

  // Ensure answer input is focused
  setTimeout(()=>{ answerInput.focus(); }, 100);
});

restartBtn.addEventListener('click', ()=>{
  // reset but keep player name
  playerName = playerName || 'Người chơi';
  playerNameShow.textContent = playerName;
  currentIndex = 0;
  score = 0;
  updateUI();
  hideCenterToast();
  clearToastTimers();
  stopQuestionTimer();
  showQuestion(currentIndex);
  if(!bgmPlaying) playBgm();
});

/* toggle background music */
toggleBgmBtn.addEventListener('click', ()=>{
  if(bgmPlaying){ pauseBgm(); }
  else { playBgm(); }
});

/* catch Enter key on input to submit */
answerInput.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ e.preventDefault(); onAnswerSubmit(); }
});
answerBtn.addEventListener('click', onAnswerSubmit);

/* ===========================
   End game
   =========================== */
function endGame(){
  stopQuestionTimer();
  // save score
  saveScore(playerName, score);
  updateLeaderboard();
  // show final toast
  showCenterToast(`Trò chơi kết thúc`, `Bạn: ${playerName} — Điểm: ${score}`, true, 8);
  // stop bgm? keep playing — up to bạn. currently we'll keep playing.
}

/* ===========================
   Init
   =========================== */
(function init(){
  // prepare background slideshow
  startSlideshow();

  // initial UI: disable answer box until player starts
  answerInput.disabled = true;
  answerBtn.disabled = false; // but it won't work until player logs in

  // timer display initial
  timerDisplay.textContent = `⏳ ${TIME_PER_QUESTION}s`;

  updateUI();
  updateLeaderboard();

  // prepare bgm (but don't play until user clicks "Bắt đầu")
  initBgm();

  // resume audio context on first user gesture (some browsers)
  function resumeAudioOnGesture(){
    if(audioCtx && audioCtx.state === 'suspended'){ audioCtx.resume().catch(()=>{}); }
    document.removeEventListener('click', resumeAudioOnGesture);
  }
  document.addEventListener('click', resumeAudioOnGesture);
})();
</script>
</body>
</html>
